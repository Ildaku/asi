{% extends 'base.html' %}
{% block title %}–û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö | Planner2{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">–ì–ª–∞–≤–Ω–∞—è</a></li>
        <li class="breadcrumb-item active">–û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>üîß –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h2>
            <p class="text-muted">
                –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–º–æ–≥–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å "–≤–∏—Å—è—â–∏–º–∏" —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–µ —Å—ã—Ä—å—ë.
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
    </div>

    <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="alert alert-info">
                        <strong>MaterialBatch –±–µ–∑ —Å—ã—Ä—å—è:</strong><br>
                        <span class="h4">{{ orphaned_material_batches|length }}</span> –∑–∞–ø–∏—Å–µ–π
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-warning">
                        <strong>BatchMaterial –±–µ–∑ MaterialBatch:</strong><br>
                        <span class="h4">{{ orphaned_batch_materials|length }}</span> –∑–∞–ø–∏—Å–µ–π
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-danger">
                        <strong>–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–ª–∞–Ω—ã:</strong><br>
                        <span class="h4">{{ problematic_plans|length }}</span> –ø–ª–∞–Ω–æ–≤
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-secondary">
                        <strong>SQL –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:</strong><br>
                        <span class="h4">
                            {% if orphaned_mb_sql and orphaned_bm_sql and orphaned_pb_sql %}
                                {{ orphaned_mb_sql|length + orphaned_bm_sql|length + orphaned_pb_sql|length }}
                            {% else %}
                                0
                            {% endif %}
                        </span> –ø—Ä–æ–±–ª–µ–º
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    {% if orphaned_material_batches or orphaned_batch_materials or problematic_plans %}
    
    <!-- MaterialBatch –±–µ–∑ —Å—ã—Ä—å—è -->
    {% if orphaned_material_batches %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">‚ùå MaterialBatch –±–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å—ã—Ä—å—è</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ID —Å—ã—Ä—å—è</th>
                            <th>–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mb in orphaned_material_batches %}
                        <tr>
                            <td>{{ mb.id }}</td>
                            <td><span class="text-danger">{{ mb.material_id }}</span> (—É–¥–∞–ª–µ–Ω–æ)</td>
                            <td>{{ mb.batch_number }}</td>
                            <td>{{ "%.2f"|format(mb.quantity) }} –∫–≥</td>
                            <td>{{ mb.created_at.strftime('%d.%m.%Y %H:%M') if mb.created_at else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- BatchMaterial –±–µ–∑ MaterialBatch -->
    {% if orphaned_batch_materials %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">‚ùå BatchMaterial –±–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ MaterialBatch</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ID MaterialBatch</th>
                            <th>ID –∑–∞–º–µ—Å–∞</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bm in orphaned_batch_materials %}
                        <tr>
                            <td>{{ bm.id }}</td>
                            <td><span class="text-danger">{{ bm.material_batch_id }}</span> (—É–¥–∞–ª–µ–Ω–æ)</td>
                            <td>{{ bm.batch_id }}</td>
                            <td>{{ "%.2f"|format(bm.quantity) }} –∫–≥</td>
                            <td>{{ bm.created_at.strftime('%d.%m.%Y %H:%M') if bm.created_at else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–ª–∞–Ω—ã -->
    {% if problematic_plans %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">‚ö†Ô∏è –ü–ª–∞–Ω—ã —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ID –ø–ª–∞–Ω–∞</th>
                            <th>–ù–æ–º–µ—Ä –ø–∞—Ä—Ç–∏–∏</th>
                            <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ü—Ä–æ–±–ª–µ–º—ã ({{ plan.problem_count }})</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plan in problematic_plans %}
                        <tr>
                            <td>{{ plan.id }}</td>
                            <td>{{ plan.batch_number }}</td>
                            <td>{{ plan.product }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if plan.status == '–∑–∞–≤–µ—Ä—à–µ–Ω' else 'warning' }}">
                                    {{ plan.status }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#problems{{ plan.id }}" 
                                        aria-expanded="false">
                                    –ü–æ–∫–∞–∑–∞—Ç—å {{ plan.problem_count }} –ø—Ä–æ–±–ª–µ–º
                                </button>
                                <div class="collapse mt-2" id="problems{{ plan.id }}">
                                    <div class="card card-body">
                                        <ul class="list-unstyled mb-0">
                                            {% for problem in plan.problems %}
                                            <li class="text-danger mb-1">
                                                <i class="fas fa-exclamation-triangle"></i> {{ problem }}
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ö–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –û—á–∏—Å—Ç–∫–∞ —É–¥–∞–ª–∏—Ç "–≤–∏—Å—è—â–∏–µ" —Å—Å—ã–ª–∫–∏. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
            </div>
            
            <form method="POST" class="d-inline">
                {% if orphaned_material_batches %}
                <button type="submit" name="action" value="cleanup_material_batches" 
                        class="btn btn-warning me-2" 
                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å {{ orphaned_material_batches|length }} MaterialBatch –±–µ–∑ —Å—ã—Ä—å—è?')">
                    <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å MaterialBatch
                </button>
                {% endif %}
                
                {% if orphaned_batch_materials %}
                <button type="submit" name="action" value="cleanup_batch_materials" 
                        class="btn btn-warning me-2"
                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å {{ orphaned_batch_materials|length }} BatchMaterial –±–µ–∑ MaterialBatch?')">
                    <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å BatchMaterial
                </button>
                {% endif %}
                
                {% if orphaned_material_batches or orphaned_batch_materials %}
                <button type="submit" name="action" value="cleanup_all" 
                        class="btn btn-danger"
                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–ø–∏—Å–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')">
                    <i class="fas fa-broom"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                </button>
                {% endif %}
            </form>
        </div>
    </div>

    {% else %}
    <!-- –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º -->
    <div class="card">
        <div class="card-body text-center">
            <div class="alert alert-success">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h4>üéâ –ü—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ!</h4>
                <p class="mb-0">–í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ—Ä—è–¥–∫–µ, "–≤–∏—Å—è—â–∏—Ö" —Å—Å—ã–ª–æ–∫ –Ω–µ—Ç.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %} 