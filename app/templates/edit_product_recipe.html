{% extends 'base.html' %}
{% block title %}Изменить рецептуру | Planner2{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Главная</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('products') }}">Продукты</a></li>
        <li class="breadcrumb-item active">Изменить рецептуру</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Изменить рецептуру продукта</h2>
            <p class="text-muted">
                <strong>Продукт:</strong> {{ product.name }}<br>
                <strong>Текущая рецептура:</strong> {{ product.recipe_templates[0].name if product.recipe_templates else 'Не указана' }}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('products') }}" class="btn btn-outline-secondary">← К списку продуктов</a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Редактирование рецептуры</h5>
        </div>
        <div class="card-body">
            <form method="POST" id="recipeForm">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Важно:</strong> Сумма процентов всех ингредиентов должна равняться 100%
                </div>

                <!-- Таблица ингредиентов -->
                <div class="table-responsive mb-3">
                    <table class="table table-bordered" id="ingredientsTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50%">Тип сырья</th>
                                <th style="width: 30%">Процент (%)</th>
                                <th style="width: 20%">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="ingredientsBody">
                            {% for item in recipe_items %}
                            <tr class="ingredient-row">
                                <td>
                                    <select name="material_type_id[]" class="form-select" required>
                                        {% for type in raw_material_types %}
                                        <option value="{{ type.id }}" {% if type.id == item.material_type_id %}selected{% endif %}>
                                            {{ type.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="number" name="percentage[]" class="form-control percentage-input" 
                                           min="0.001" max="100" step="0.001" 
                                           value="{{ "%.3f"|format(item.percentage) }}" required>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-ingredient">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Кнопка добавления ингредиента -->
                <div class="mb-3">
                    <button type="button" class="btn btn-outline-primary" id="addIngredient">
                        <i class="fas fa-plus"></i> Добавить ингредиент
                    </button>
                </div>

                <!-- Информация о сумме процентов -->
                <div class="alert" id="percentageAlert">
                    <strong>Сумма процентов: <span id="totalPercentage">0.000</span>%</strong>
                </div>

                <!-- Кнопки формы -->
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('products') }}" class="btn btn-secondary">Отмена</a>
                    <button type="submit" class="btn btn-primary" id="saveButton">
                        <i class="fas fa-save"></i> Сохранить рецептуру
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ingredientsBody = document.getElementById('ingredientsBody');
    const addIngredientBtn = document.getElementById('addIngredient');
    const percentageAlert = document.getElementById('percentageAlert');
    const totalPercentageSpan = document.getElementById('totalPercentage');
    const saveButton = document.getElementById('saveButton');
    const rawMaterialTypes = {{ raw_material_types|tojson }};

    // Функция для обновления суммы процентов
    function updateTotalPercentage() {
        const percentageInputs = document.querySelectorAll('.percentage-input');
        let total = 0;
        
        percentageInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        
        totalPercentageSpan.textContent = total.toFixed(3);
        
        // Изменяем цвет алерта в зависимости от суммы
        if (Math.abs(total - 100) < 0.001) {
            percentageAlert.className = 'alert alert-success';
            saveButton.disabled = false;
        } else if (total > 100) {
            percentageAlert.className = 'alert alert-danger';
            saveButton.disabled = true;
        } else {
            percentageAlert.className = 'alert alert-warning';
            saveButton.disabled = true;
        }
    }

    // Функция для добавления новой строки ингредиента
    function addIngredientRow() {
        const newRow = document.createElement('tr');
        newRow.className = 'ingredient-row';
        
        const materialTypeSelect = document.createElement('td');
        const select = document.createElement('select');
        select.name = 'material_type_id[]';
        select.className = 'form-select';
        select.required = true;
        
        // Добавляем опции для выбора типа сырья
        rawMaterialTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            select.appendChild(option);
        });
        
        materialTypeSelect.appendChild(select);
        
        const percentageTd = document.createElement('td');
        const percentageInput = document.createElement('input');
        percentageInput.type = 'number';
        percentageInput.name = 'percentage[]';
        percentageInput.className = 'form-control percentage-input';
        percentageInput.min = '0.001';
        percentageInput.max = '100';
        percentageInput.step = '0.001';
        percentageInput.required = true;
        percentageInput.addEventListener('input', updateTotalPercentage);
        percentageTd.appendChild(percentageInput);
        
        const actionsTd = document.createElement('td');
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-sm btn-outline-danger remove-ingredient';
        removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
        removeBtn.addEventListener('click', function() {
            if (ingredientsBody.children.length > 1) {
                newRow.remove();
                updateTotalPercentage();
            }
        });
        actionsTd.appendChild(removeBtn);
        
        newRow.appendChild(materialTypeSelect);
        newRow.appendChild(percentageTd);
        newRow.appendChild(actionsTd);
        
        ingredientsBody.appendChild(newRow);
        updateTotalPercentage();
    }

    // Обработчик для кнопки добавления ингредиента
    addIngredientBtn.addEventListener('click', addIngredientRow);

    // Обработчики для удаления ингредиентов
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-ingredient')) {
            if (ingredientsBody.children.length > 1) {
                e.target.closest('.ingredient-row').remove();
                updateTotalPercentage();
            }
        }
    });

    // Обработчики для изменения процентов
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('percentage-input')) {
            updateTotalPercentage();
        }
    });

    // Инициализация при загрузке страницы
    updateTotalPercentage();
});
</script>
{% endblock %} 